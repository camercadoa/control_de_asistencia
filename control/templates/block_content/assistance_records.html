{% extends "dashboard.html" %}

{% block title %}Registros de Asistencia{% endblock %}
{% block container_class %}justify-content-start align-items-start{% endblock %}

{% block content %}
<h3 class="mb-4 d-flex justify-content-center align-items-center fw-bold">Registros de Asistencia</h3>

<!-- Filtros -->
<div class="row mb-3 g-2 align-items-end">
    <div class="form-floating col-md-6">
        <select id="filterEmployee" class="form-select">
            <option value="">Todos</option>
        </select>
        <label for="filterEmployee" class="form-label">Empleado</label>
    </div>
    <div class="form-floating col-md-3">
        <input type="date" id="filterStartDate" class="form-control">
        <label for="filterStartDate" class="form-label">Fecha inicio</label>
    </div>
    <div class="form-floating col-md-3">
        <input type="date" id="filterEndDate" class="form-control">
        <label for="filterEndDate" class="form-label">Fecha fin</label>
    </div>
</div>

<!-- Tabla -->
<div class="card shadow-sm border-0 rounded-3">
    <div class="card-body p-3">
        <div class="table-responsive-md">
            <table class="table table-striped table-hover table-borderless align-middle text-center w-100 fs-6" id="AttendanceTable">
                <thead class="table-dark border-bottom border-2 fw-semibold">
                    <tr>
                        <th>#</th>
                        <th>EMPLEADO</th>
                        <th>FECHA</th>
                        <th>HORA</th>
                        <th>DESCRIPCIÓN</th>
                        <th>LUGAR</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        let empleados = [];
        let table = null;

        // Traer todos los empleados para el filtro
        try {
            const resEmp = await fetch("/api/empleados/");
            empleados = await resEmp.json();
            const select = document.getElementById("filterEmployee");
            empleados.forEach(emp => {
                const option = document.createElement("option");
                option.value = emp.id;
                option.textContent = emp.nombre_completo.toUpperCase();
                select.appendChild(option);
            });
        } catch {
            showAlert("Error cargando empleados para el filtro", "danger");
        }

        // Inicializar DataTable
        table = initDataTable("#AttendanceTable", {
            ajax: {
                url: "/api/registros-asistencias/",
                dataSrc: ""
            },
            columns: [
                { data: null, render: (d,t,r,m) => m.row + 1 },
                { data: "nombre_empleado", render: nombre_empleado => nombre_empleado ? nombre_empleado.toUpperCase() : "-" },
                { data: "fecha", render: fecha => fecha || "-" },
                { data: "hora", render: hora => hora || "-" },
                { data: "descripcion_registro", render: descripcion_registro => descripcion_registro.toUpperCase() || "-" },
                { data: "lugar_registro", render: lugar_registro => lugar_registro ? lugar_registro.toUpperCase() : "-" }
            ]
        });

        // Filtro automático con DataTables API
        $.fn.dataTable.ext.search.push((settings, data, dataIndex, rowData) => {
            const empId = document.getElementById("filterEmployee").value;
            const startDate = document.getElementById("filterStartDate").value;
            const endDate = document.getElementById("filterEndDate").value;

            let show = true;

            // Filtrar por empleado
            if (empId && rowData.fk_empleado != parseInt(empId)) {
                show = false;
            }

            // Filtrar por fecha inicio
            if(startDate) {
                const regDate = new Date(rowData.fecha.split("/").reverse().join("-"));
                if(regDate < new Date(startDate)) show = false;
            }

            // Filtrar por fecha fin
            if(endDate) {
                const regDate = new Date(rowData.fecha.split("/").reverse().join("-"));
                if(regDate > new Date(endDate)) show = false;
            }

            return show;
        });

        // Eventos de filtro
        document.getElementById("filterEmployee").addEventListener("change", () => table.draw());
        document.getElementById("filterStartDate").addEventListener("change", () => table.draw());
        document.getElementById("filterEndDate").addEventListener("change", () => table.draw());
    });
</script>
{% endblock %}
