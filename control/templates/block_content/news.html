{% extends "dashboard.html" %}

{% block title %}Novedades{% endblock %}
{% block container_class %}justify-content-start align-items-start{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12 col-md-8 d-flex align-items-center justify-content-center justify-content-md-start">
        <h5 class="fw-bold mb-2 text-center text-md-start">Novedades de Asistencia</h5>
    </div>
    <div class="col-12 col-md-4 text-center text-md-end">
        <button class="btn btn-success py-2" data-bs-toggle="modal" data-bs-target="#modalCreate">
            <i class="bi bi-plus-circle fs-5 me-2"></i>Agregar Novedad
        </button>
    </div>
</div>

<!-- Filtros -->
<div class="accordion mb-1" id="accordionFilters">
    <div class="accordion-item border-0 shadow-sm rounded-3">
        <h2 class="accordion-header" id="headingFilters">
            <button class="accordion-button collapsed fw-semibold text-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilters" aria-expanded="false" aria-controls="collapseFilters">
                <i class="bi bi-funnel-fill me-2 text-primary"></i> Filtros de búsqueda
            </button>
        </h2>
        <div id="collapseFilters" class="accordion-collapse collapse" aria-labelledby="headingFilters" data-bs-parent="#accordionFilters">
            <div class="accordion-body pt-3">
                <div class="row g-3 align-items-center">
                    <!-- Filtro de Empleado -->
                    <div class="form-floating col-md-3">
                        <select id="filterEmployee" class="form-select">
                            <option value="">Todos</option>
                        </select>
                        <label for="filterEmployee" class="form-label">Empleado</label>
                    </div>
                    <!-- Filtro por Mes -->
                    <div class="form-floating col-md-2">
                        <input type="month" id="filterMonth" class="form-control">
                        <label for="filterMonth" class="form-label">Mes</label>
                    </div>
                    <!-- Filtro de Tipo de Novedad -->
                    <div class="form-floating col-md-3">
                        <select id="filterTipoNovedad" class="form-select">
                            <option value="">Todas</option>
                        </select>
                        <label for="filterTipoNovedad" class="form-label">Tipo de Novedad</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Limpiar Filtros -->
<div class="d-flex justify-content-end mb-3">
    <button id="clearFilters" class="btn btn-link text-decoration-none text-secondary p-0 fw-semibold" disabled>
        Limpiar filtros
    </button>
</div>


<!-- Tabla -->
<div class="card shadow-sm border-0 rounded-3">
    <div class="card-body p-3">
        <div class="table-responsive">
            <table class="table table-striped table-hover table-borderless align-middle text-center w-100" id="NovedadesTable">
                <thead class="table-dark border-bottom border-2 fw-semibold">
                    <tr>
                        <th>#</th>
                        <th>EMPLEADO</th>
                        <th>TIPO NOVEDAD</th>
                        <th>FECHA INICIO</th>
                        <th>FECHA FIN</th>
                        <th>OBSERVACIÓN</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<!-- Modal Crear -->
<div class="modal fade" id="modalCreate" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <form id="formCreate">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Novedad</h5>
                </div>
                <div class="modal-body text-center text-secondary-emphasis m-0">
                    <div class="form-floating mb-3">
                        <select class="form-select rounded-3" name="fk_empleado" id="createEmpleado">
                            <option value="">Cargando empleados...</option>
                        </select>
                        <label for="createEmpleado">Empleado</label>
                    </div>
                    <div class="form-floating mb-3">
                        <select class="form-select rounded-3" name="fk_tipo_novedad" id="createTipoNovedad">
                            <option value="">Cargando tipos...</option>
                        </select>
                        <label for="createTipoNovedad">Tipo de Novedad</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="date" class="form-control rounded-3" name="fecha_inicio" id="createFechaInicio">
                        <label for="createFechaInicio">Fecha Inicio</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="date" class="form-control rounded-3" name="fecha_fin" id="createFechaFin">
                        <label for="createFechaFin">Fecha Fin</label>
                    </div>
                    <div class="form-floating mb-3">
                        <textarea class="form-control rounded-3" name="observacion" id="createObservacion" style="height: 80px"></textarea>
                        <label for="createObservacion">Observación</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar -->
<div class="modal fade" id="modalEdit" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <form id="formEdit">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Editar Novedad</h5>
                </div>
                <div class="modal-body text-center text-secondary-emphasis m-0">
                    <input type="hidden" name="id">
                    <div class="form-floating mb-3">
                        <select class="form-select rounded-3" name="fk_empleado" id="editEmpleado">
                            <option value="">Cargando empleados...</option>
                        </select>
                        <label for="editEmpleado">Empleado</label>
                    </div>
                    <div class="form-floating mb-3">
                        <select class="form-select rounded-3" name="fk_tipo_novedad" id="editTipoNovedad">
                            <option value="">Cargando tipos...</option>
                        </select>
                        <label for="editTipoNovedad">Tipo de Novedad</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="date" class="form-control rounded-3" name="fecha_inicio" id="editFechaInicio">
                        <label for="editFechaInicio">Fecha Inicio</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="date" class="form-control rounded-3" name="fecha_fin" id="editFechaFin">
                        <label for="editFechaFin">Fecha Fin</label>
                    </div>
                    <div class="form-floating mb-3">
                        <textarea class="form-control rounded-3" name="observacion" id="editObservacion" style="height: 80px"></textarea>
                        <label for="editObservacion">Observación</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Actualizar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Eliminar -->
<div class="modal fade" id="modalDelete" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-body">
                ¿Estás seguro de eliminar esta novedad?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
    const filterInputs = [
        "filterEmployee",
        "filterTipoNovedad",
        "filterMonth"
    ].map(id => document.getElementById(id));

    // Inicializar DataTable
    const table = initDataTable("#NovedadesTable", {
        ajax: { url: "/api/novedades-asistencia/", dataSrc: "" },
        columns: [
            { data: null, render: (d,t,r,m) => m.row + 1 },
            { data: "nombre_empleado", render: d => d ? d.toUpperCase() : "-" },
            { data: "tipo_novedad", render: d => d ? d.toUpperCase() : "-" },
            { data: "fecha_inicio", render: d => d ? formatDateDDMMYYYY(d) : "-" },
            { data: "fecha_fin", render: d => d ? formatDateDDMMYYYY(d) : "-" },
            { data: "observacion", render: d => d || "-" },
            {
                data: null,
                orderable: false,
                render: (data,type,row) => `
                    <div class="d-flex justify-content-center gap-3">
                        <button class="btn btn-sm btn-primary edit-btn"
                                data-id="${row.id}"
                                data-empleado-id="${row.fk_empleado}"
                                data-tipo-id="${row.fk_tipo_novedad}"
                                data-fecha-inicio="${row.fecha_inicio}"
                                data-fecha-fin="${row.fecha_fin}"
                                data-observacion="${row.observacion ?? ''}"
                                data-bs-toggle="tooltip" title="Editar">
                            <i class="bi bi-pencil-square fs-5"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-btn"
                                data-id="${row.id}"
                                data-bs-toggle="tooltip" title="Eliminar">
                            <i class="bi bi-trash3 fs-5"></i>
                        </button>
                    </div>
                `
            }
        ]
    });

    // Cargar empleados y tipos de Novedades
    let empleados = [];
    let tipos = [];

    try {
        const [resEmp, resTipo] = await Promise.all([
            fetch("/api/empleados/"),
            fetch("/api/tipos-novedad/")
        ]);

        empleados = await resEmp.json();
        tipos = await resTipo.json();

        // Filtros
        fillSelect("filterEmployee", empleados, "Todos", "nombre_completo");
        fillSelect("filterTipoNovedad", tipos, "Todas", "tipo");

        // Formularios
        fillSelect("createEmpleado", empleados, "Selecciona un empleado", "nombre_completo");
        fillSelect("editEmpleado", empleados, "Selecciona un empleado", "nombre_completo");
        fillSelect("createTipoNovedad", tipos, "Selecciona un tipo de novedad", "tipo");
        fillSelect("editTipoNovedad", tipos, "Selecciona un tipo de novedad", "tipo");

    } catch (error) {
        console.error(error);
        showAlert("Error cargando empleados o tipos de novedad", "danger");
    }

    // Filtro automático con DataTables API
    $.fn.dataTable.ext.search.push((settings, data, dataIndex, rowData) => {
        const empId = document.getElementById("filterEmployee").value;
        const tipoId = document.getElementById("filterTipoNovedad").value;
        const filterMonth = document.getElementById("filterMonth").value; // formato YYYY-MM

        let show = true;

        if (empId && rowData.fk_empleado != parseInt(empId)) show = false;
        if (tipoId && rowData.fk_tipo_novedad != parseInt(tipoId)) show = false;

        if (filterMonth && rowData.fecha_inicio) {
            const fecha = new Date(rowData.fecha_inicio);
            const year = fecha.getFullYear();
            const month = String(fecha.getMonth() + 1).padStart(2, "0");
            const rowMonth = `${year}-${month}`;
            if (rowMonth !== filterMonth) show = false;
        }

        return show;
    });

    // Eventos de filtros
    document.getElementById("filterEmployee").addEventListener("change", () => table.draw());
    document.getElementById("filterTipoNovedad").addEventListener("change", () => table.draw());
    document.getElementById("filterMonth").addEventListener("change", () => table.draw());

    // Limpiar Filtros
    const clearBtn = document.getElementById("clearFilters");
    const checkFilters = () => {
        const hasFilters = filterInputs.some(input => input.value && input.value.trim() !== "");
        clearBtn.disabled = !hasFilters;
        clearBtn.classList.toggle("text-secondary", !hasFilters);
        clearBtn.classList.toggle("text-primary", hasFilters);
    };

    // Escucha cambios en todos los filtros
    filterInputs.forEach(input => {
        input.addEventListener("change", checkFilters);
        input.addEventListener("input", checkFilters);
    });

    // botón para limpiar filtros
    clearBtn.addEventListener("click", () => {
        filterInputs.forEach(input => input.value = "");
        table.search("").columns().search("").draw();
        checkFilters();
        // Cerrar acordeón al limpiar
        const collapse = bootstrap.Collapse.getOrCreateInstance(document.getElementById("collapseFilters"));
        collapse.hide();
    });

    // Inicializar estado del botón
    checkFilters();

    //  Crear
    const createForm = document.getElementById("formCreate");
    const createBtn = createForm.querySelector("button[type=submit]");
    const originalTextCreate = createBtn.innerHTML;

    createForm.addEventListener("submit", async e => {
        e.preventDefault();
        disableButtonWithSpinner(createBtn, "Guardando...");
        try {
            const res = await fetch("/api/novedades-asistencia/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify(Object.fromEntries(new FormData(createForm).entries()))
            });
            if (res.ok) {
                showAlert("Novedad creada correctamente", "success");
                bootstrap.Modal.getInstance(document.getElementById("modalCreate")).hide();
                createForm.reset();
                table.ajax.reload(null, false);
            } else showAlert("Error al crear la novedad", "danger");
        } catch {
            showAlert("Error inesperado", "danger");
        } finally {
            enableButton(createBtn, originalTextCreate);
        }
    });

    resetModalForm("modalCreate", "formCreate", [
        "createEmpleado", "createTipoNovedad", "createFechaInicio", "createFechaFin", "createObservacion"
    ]);

    //  Editar
    const editForm = document.getElementById("formEdit");
    const editBtn = editForm.querySelector("button[type=submit]");
    const originalTextEdit = editBtn.innerHTML;

    document.getElementById("NovedadesTable").addEventListener("click", e => {
        const btn = e.target.closest(".edit-btn");
        if (!btn) return;

        editForm.querySelector("[name=id]").value = btn.dataset.id;
        editForm.querySelector("[name=fk_empleado]").value = btn.dataset.empleadoId;
        editForm.querySelector("[name=fk_tipo_novedad]").value = btn.dataset.tipoId;
        editForm.querySelector("[name=fecha_inicio]").value = btn.dataset.fechaInicio;
        editForm.querySelector("[name=fecha_fin]").value = btn.dataset.fechaFin;
        editForm.querySelector("[name=observacion]").value = btn.dataset.observacion || "";

        bootstrap.Modal.getOrCreateInstance(document.getElementById("modalEdit")).show();
    });

    editForm.addEventListener("submit", async e => {
        e.preventDefault();
        disableButtonWithSpinner(editBtn, "Actualizando...");
        const idNovedad = editForm.querySelector("[name=id]").value;
        try {
            const res = await fetch(`/api/novedades-asistencia/${idNovedad}/`, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify(Object.fromEntries(new FormData(editForm).entries()))
            });
            if (res.ok) {
                showAlert("Novedad actualizada correctamente", "success");
                bootstrap.Modal.getInstance(document.getElementById("modalEdit")).hide();
                table.ajax.reload(null, false);
            } else showAlert("Error al actualizar la novedad", "danger");
        } catch {
            showAlert("Error inesperado", "danger");
        } finally {
            enableButton(editBtn, originalTextEdit);
        }
    });

    resetModalForm("modalEdit", "formEdit", [
        "editEmpleado", "editTipoNovedad", "editFechaInicio", "editFechaFin", "editObservacion"
    ]);

    //  Eliminar
    let deleteId = null;
    const deleteBtn = document.getElementById("confirmDelete");

    document.getElementById("NovedadesTable").addEventListener("click", e => {
        const btn = e.target.closest(".delete-btn");
        if (!btn) return;
        deleteId = btn.dataset.id;
        bootstrap.Modal.getOrCreateInstance(document.getElementById("modalDelete")).show();
    });

    deleteBtn.addEventListener("click", async () => {
        if (!deleteId) return;
        disableButtonWithSpinner(deleteBtn, "Eliminando...");
        try {
            const res = await fetch(`/api/novedades-asistencia/${deleteId}/`, {
                method: "DELETE",
                headers: { "X-CSRFToken": "{{ csrf_token }}" }
            });
            if (res.ok) {
                showAlert("Novedad eliminada correctamente", "success");
                bootstrap.Modal.getInstance(document.getElementById("modalDelete")).hide();
                table.ajax.reload(null, false);
            } else showAlert("Error al eliminar la novedad", "danger");
        } catch {
            showAlert("Error inesperado", "danger");
        } finally {
            deleteId = null;
            enableButton(deleteBtn, "Eliminar");
        }
    });
});
</script>
{% endblock %}
