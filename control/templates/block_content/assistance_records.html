{% extends "dashboard.html" %}

{% block title %}Registros de Asistencia{% endblock %}
{% block container_class %}justify-content-start align-items-start{% endblock %}

{% block content %}
<h5 class="mb-4 d-flex justify-content-center align-items-center fw-bold">Registros de Asistencia</h5>

<!-- Filtros -->
<div class="row mb-3 g-2 align-items-center">
    <!-- Filtro de Empleado -->
    <div class="form-floating col-md-2">
        <select id="filterEmployee" class="form-select">
            <option value="">Todos</option>
        </select>
        <label for="filterEmployee" class="form-label">Empleado</label>
    </div>
    <!-- Filtros de Fecha -->
    <div class="form-floating col-md-2">
        <input type="date" id="filterStartDate" class="form-control">
        <label for="filterStartDate" class="form-label">Fecha inicio</label>
    </div>
    <div class="form-floating col-md-2">
        <input type="date" id="filterEndDate" class="form-control">
        <label for="filterEndDate" class="form-label">Fecha fin</label>
    </div>
    <!-- Filtro de Descripción -->
    <div class="form-floating col-md-1">
        <select id="filterDescription" class="form-select">
            <option value="">Todos</option>
            <option value="Entrada">Entrada</option>
            <option value="Salida">Salida</option>
        </select>
        <label for="filterDescription" class="form-label">Descripción</label>
    </div>
    <!-- Filtro de Áreas de Trabajo -->
    <div class="form-floating col-md-2">
        <select id="filterWorkArea" class="form-select">
            <option value="">Todas</option>
        </select>
        <label for="filterWorkArea" class="form-label">Área de Trabajo</label>
    </div>
    <!-- Filtro de Sede -->
    <div class="form-floating col-md-2">
        <select id="filterSede" class="form-select">
            <option value="">Todas</option>
        </select>
        <label for="filterSede" class="form-label">Sede</label>
    </div>
    <!-- Botón Limpiar -->
    <div class="col-12 col-md-auto text-center">
        <button id="clearFilters"
                class="btn btn-outline-secondary w-100 w-md-auto py-2 d-flex align-items-center justify-content-center gap-2">
            <i class="bi bi-x-circle fs-5"></i>
            <span class="d-md-none">Limpiar</span>
        </button>
    </div>
</div>

<!-- Tabla -->
<div class="card shadow-sm border-0 rounded-3">
    <div class="card-body p-3">
        <div class="table-responsive-md">
            <table class="table table-striped table-hover table-borderless align-middle text-center w-100" id="AttendanceTable">
                <thead class="table-dark border-bottom border-2 fw-semibold">
                    <tr>
                        <th>#</th>
                        <th>EMPLEADO</th>
                        <th>FECHA</th>
                        <th>HORA</th>
                        <th>DESCRIPCIÓN</th>
                        <th>ESTADO</th>
                        <th>MINUTOS</th>
                        <th>LUGAR</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        let empleados = [];
        let table = null;

        // Inicializar DataTable
        table = initDataTable("#AttendanceTable", {
            ajax: {
                url: "/api/registros-asistencias/",
                dataSrc: ""
            },
            columns: [
                { data: null, render: (d,t,r,m) => m.row + 1 },
                { data: "nombre_empleado", render: nombre_empleado => nombre_empleado ? nombre_empleado.toUpperCase() : "-" },
                { data: "fecha", render: fecha => fecha || "-" },
                { data: "hora", render: hora => hora || "-" },
                { data: "descripcion_registro", render: descripcion_registro => descripcion_registro.toUpperCase() || "-" },
                { data: "estado_registro", render: estado_registro => estado_registro ? estado_registro.toUpperCase() : "-" },
                { data: "minutos", render: minutos => minutos !== null ? `${minutos} min` : "-" },
                { data: "lugar_registro", render: lugar_registro => lugar_registro ? lugar_registro.toUpperCase() : "-" }
            ]
        });

        // Cargar empleados, áreas de trabajo y sedes para los filtros
        try {
            const [resEmp, resAreas, resSedes] = await Promise.all([
                fetch("/api/empleados/"),
                fetch("/api/areas-trabajo/"),
                fetch("/api/sedes/")
            ]);

            const [empleadosData, areasData, sedesData] = await Promise.all([
                resEmp.json(),
                resAreas.json(),
                resSedes.json()
            ]);
            // Llenar select de empleados
            const selectEmp = document.getElementById("filterEmployee");
            empleadosData.forEach(emp => {
                const option = document.createElement("option");
                option.value = emp.id;
                option.textContent = emp.nombre_completo.toUpperCase();
                selectEmp.appendChild(option);
            });

            // Llenar select de áreas
            const selectArea = document.getElementById("filterWorkArea");
            areasData.forEach(area => {
                const option = document.createElement("option");
                option.value = area.id;
                option.textContent = area.area.toUpperCase();
                selectArea.appendChild(option);
            });

            // Llenar select de sedes
            const selectSede = document.getElementById("filterSede");
            sedesData.forEach(sede => {
                const option = document.createElement("option");
                option.value = sede.id;
                option.textContent = `${sede.ubicacion.toUpperCase()} - ${sede.ciudad.toUpperCase()}`;
                selectSede.appendChild(option);
            });

        } catch (error) {
            console.log(error)
            showAlert("Error cargando empleados, áreas de trabajo o sede", "danger");
        }


        // Filtro automático con DataTables API
        $.fn.dataTable.ext.search.push((settings, data, dataIndex, rowData) => {
            const empId = document.getElementById("filterEmployee").value;
            const startDate = document.getElementById("filterStartDate").value;
            const endDate = document.getElementById("filterEndDate").value;
            const description = document.getElementById("filterDescription").value;
            const workAreaId = document.getElementById("filterWorkArea").value;
            const sedeId = document.getElementById("filterSede").value;

            let show = true;

            // Filtrar por empleado
            if (empId && rowData.fk_empleado != parseInt(empId)) {
                show = false;
            }

            // Filtrar por fecha inicio
            if (startDate) {
                const regDate = new Date(rowData.fecha.split("/").reverse().join("-"));
                if (regDate < new Date(startDate)) show = false;
            }

            // Filtrar por fecha fin
            if (endDate) {
                const regDate = new Date(rowData.fecha.split("/").reverse().join("-"));
                if (regDate > new Date(endDate)) show = false;
            }

            // Filtrar por descripción
            if (description && rowData.descripcion_registro.toLowerCase() !== description.toLowerCase()) {
                show = false;
            }

            // Filtrar por área de trabajo
            if (workAreaId && !rowData.fk_areas_trabajo.includes(parseInt(workAreaId))) {
                show = false;
            }

            // Filtrar por sede
            if (sedeId && rowData.fk_sede != parseInt(sedeId)) {
                show = false;
            }

            return show;
        });

        // Eventos de filtros
        document.getElementById("filterEmployee").addEventListener("change", () => table.draw());
        document.getElementById("filterStartDate").addEventListener("change", () => table.draw());
        document.getElementById("filterEndDate").addEventListener("change", () => table.draw());
        document.getElementById("filterDescription").addEventListener("input", () => table.draw());
        document.getElementById("filterWorkArea").addEventListener("change", () => table.draw());
        document.getElementById("filterSede").addEventListener("change", () => table.draw());

        // Botón Limpiar Filtros
        document.getElementById("clearFilters").addEventListener("click", () => {
            document.getElementById("filterEmployee").value = "";
            document.getElementById("filterStartDate").value = "";
            document.getElementById("filterEndDate").value = "";
            document.getElementById("filterDescription").value = "";
            document.getElementById("filterWorkArea").value = "";
            document.getElementById("filterSede").value = "";
            table.search("").columns().search("").draw();
        });
    });
</script>
{% endblock %}
