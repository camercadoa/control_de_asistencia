{% extends "dashboard.html" %}

{% block title %}Novedades{% endblock %}
{% block container_class %}justify-content-start align-items-start{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12 col-md-8 d-flex align-items-center justify-content-center justify-content-md-start">
        <h3 class="fw-bold mb-2 text-center text-md-start">Novedades de Asistencia</h3>
    </div>
    <div class="col-12 col-md-4 text-center text-md-end">
        <button class="btn btn-success py-2" data-bs-toggle="modal" data-bs-target="#modalCreate">
            <i class="bi bi-plus-circle fs-5 me-2"></i>Agregar Novedad
        </button>
    </div>
</div>

<!-- Tabla -->
<div class="card shadow-sm border-0 rounded-3">
    <div class="card-body p-3">
        <div class="table-responsive">
        <table class="table table-striped table-hover table-borderless align-middle text-center w-100 fs-6" id="NovedadesTable">
            <thead class="table-dark border-bottom border-2 fw-semibold">
            <tr>
                <th scope="col">#</th>
                <th scope="col">EMPLEADO</th>
                <th scope="col">TIPO NOVEDAD</th>
                <th scope="col">FECHA INICIO</th>
                <th scope="col">FECHA FIN</th>
                <th scope="col">OBSERVACIÓN</th>
                <th scope="col">ACCIONES</th>
            </tr>
            </thead>
        </table>
        </div>
    </div>
</div>

<!-- Modal Crear -->
<div class="modal fade" id="modalCreate" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <form id="formCreate">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Novedad</h5>
                </div>
                <div class="modal-body text-center text-secondary-emphasis m-0">
                    <div class="form-floating mb-3">
                        <select class="form-select rounded-3" name="fk_empleado" id="createEmpleado">
                            <option value="">Cargando empleados...</option>
                        </select>
                        <label for="createEmpleado">Empleado</label>
                    </div>
                    <div class="form-floating mb-3">
                        <select class="form-select rounded-3" name="fk_tipo_novedad" id="createTipoNovedad">
                            <option value="">Cargando tipos...</option>
                        </select>
                        <label for="createTipoNovedad">Tipo de Novedad</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="date" class="form-control rounded-3" name="fecha_inicio" id="createFechaInicio">
                        <label for="createFechaInicio">Fecha Inicio</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="date" class="form-control rounded-3" name="fecha_fin" id="createFechaFin">
                        <label for="createFechaFin">Fecha Fin</label>
                    </div>
                    <div class="form-floating mb-3">
                        <textarea class="form-control rounded-3" name="observacion" id="createObservacion" style="height: 80px"></textarea>
                        <label for="createObservacion">Observación</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar -->
<div class="modal fade" id="modalEdit" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <form id="formEdit">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Editar Novedad</h5>
                </div>
                <div class="modal-body text-center text-secondary-emphasis m-0">
                    <input type="hidden" name="id">
                    <div class="form-floating mb-3">
                        <select class="form-select rounded-3" name="fk_empleado" id="editEmpleado">
                            <option value="">Cargando empleados...</option>
                        </select>
                        <label for="editEmpleado">Empleado</label>
                    </div>
                    <div class="form-floating mb-3">
                        <select class="form-select rounded-3" name="fk_tipo_novedad" id="editTipoNovedad">
                            <option value="">Cargando tipos...</option>
                        </select>
                        <label for="editTipoNovedad">Tipo de Novedad</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="date" class="form-control rounded-3" name="fecha_inicio" id="editFechaInicio">
                        <label for="editFechaInicio">Fecha Inicio</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="date" class="form-control rounded-3" name="fecha_fin" id="editFechaFin">
                        <label for="editFechaFin">Fecha Fin</label>
                    </div>
                    <div class="form-floating mb-3">
                        <textarea class="form-control rounded-3" name="observacion" id="editObservacion" style="height: 80px"></textarea>
                        <label for="editObservacion">Observación</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Actualizar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Eliminar -->
<div class="modal fade" id="modalDelete" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-body">
                ¿Estás seguro de eliminar esta novedad?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    // Inicializar DataTable
    const table = initDataTable("#NovedadesTable", {
        ajax: { url: "/api/novedades-asistencia/", dataSrc: "" },
        columns: [
            { data: null, render: (d,t,r,m) => m.row + 1 },
            { data: "nombre_empleado", render: d => d.toUpperCase() },
            { data: "tipo_novedad", render: d => d.toUpperCase() },
            { data: "fecha_inicio", render: d => d ? formatDateDDMMYYYY(d) : '' },
            { data: "fecha_fin", render: d => d ? formatDateDDMMYYYY(d) : '' },
            { data: "observacion", render: d => d||"-" },
            { data: null, orderable:false, render: (data,type,row)=>`
                <div class="d-flex justify-content-center gap-3">
                    <button class="btn btn-sm btn-primary edit-btn"
                            data-id="${row.id}"
                            data-empleado-id="${row.fk_empleado}"
                            data-tipo-id="${row.fk_tipo_novedad}"
                            data-fecha-inicio="${row.fecha_inicio}"
                            data-fecha-fin="${row.fecha_fin}"
                            data-observacion="${row.observacion??''}"
                            data-bs-toggle="tooltip" data-bs-placement="bottom"
                            data-bs-title="Editar">
                        <i class="bi bi-pencil-square fs-5"></i>
                    </button>
                    <button class="btn btn-sm btn-danger delete-btn"
                        data-id="${row.id}"
                        data-bs-toggle="tooltip" data-bs-placement="bottom"
                        data-bs-title="Eliminar">
                        <i class="bi bi-trash3 fs-5"></i>
                    </button>
                </div>
            `}
        ]
    });

    // Función para cargar selects dinámicos con búsqueda
    async function loadSelect(url, selectId, placeholder){
        const select = document.getElementById(selectId);
        select.innerHTML = `<option value="">Cargando...</option>`;
        try{
            const res = await fetch(url);
            const data = await res.json();
            select.innerHTML = `<option value="">${placeholder}</option>`;
            data.forEach(item=>{
                const text = item.nombre_completo ?? item.tipo ?? item.tipo;
                select.innerHTML += `<option value="${item.id}">${text.toUpperCase()}</option>`;
            });
        }catch{
            select.innerHTML = `<option value="">Error cargando datos</option>`;
        }
    }

    // Cargar selects de crear y editar
    loadSelect("/api/empleados/","createEmpleado","Selecciona un empleado");
    loadSelect("/api/empleados/","editEmpleado","Selecciona un empleado");
    loadSelect("/api/tipos-novedad/","createTipoNovedad","Selecciona un tipo de novedad");
    loadSelect("/api/tipos-novedad/","editTipoNovedad","Selecciona un tipo de novedad");

    //  Crear
    const createForm = document.getElementById("formCreate");
    const createBtn = createForm.querySelector("button[type=submit]");
    const originalTextCreate = createBtn.innerHTML;
    createForm.addEventListener("submit", async e=>{
        e.preventDefault();
        disableButtonWithSpinner(createBtn,"Guardando...");
        try{
            const res = await fetch("/api/novedades-asistencia/",{
                method:"POST",
                headers:{
                    "Content-Type":"application/json",
                    "X-CSRFToken":"{{ csrf_token }}"
                },
                body: JSON.stringify(Object.fromEntries(new FormData(createForm).entries()))
            });
            if(res.ok){
                showAlert("Novedad creada correctamente","success");
                bootstrap.Modal.getInstance(document.getElementById("modalCreate")).hide();
                createForm.reset();
                table.ajax.reload(null,false);
            } else showAlert("Error al crear la novedad","danger");
        }catch{
            showAlert("Error inesperado","danger");
        }finally{
            enableButton(createBtn,originalTextCreate);
        }
    });

    resetModalForm("modalCreate","formCreate",["createEmpleado","createTipoNovedad","createFechaInicio","createFechaFin","createObservacion"]);

    //  Editar
    const editForm = document.getElementById("formEdit");
    const editBtn = editForm.querySelector("button[type=submit]");
    const originalTextEdit = editBtn.innerHTML;

    document.getElementById("NovedadesTable").addEventListener("click", e => {
        const btn = e.target.closest(".edit-btn");
        if (!btn) return;

        editForm.querySelector("[name=id]").value = btn.dataset.id;
        editForm.querySelector("[name=fk_empleado]").value = btn.dataset.empleadoId;
        editForm.querySelector("[name=fk_tipo_novedad]").value = btn.dataset.tipoId;
        editForm.querySelector("[name=fecha_inicio]").value = btn.dataset.fechaInicio;
        editForm.querySelector("[name=fecha_fin]").value = btn.dataset.fechaFin;

        editForm.querySelector("[name=observacion]").value = btn.dataset.observacion || "";

        bootstrap.Modal.getOrCreateInstance(document.getElementById("modalEdit")).show();
    });

    editForm.addEventListener("submit", async e=>{
        e.preventDefault();
        disableButtonWithSpinner(editBtn,"Actualizando...");
        const idNovedad = editForm.querySelector("[name=id]").value;
        try{
            const res = await fetch(`/api/novedades-asistencia/${idNovedad}/`,{
                method:"PATCH",
                headers:{
                    "Content-Type":"application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify(Object.fromEntries(new FormData(editForm).entries()))
            });
            if(res.ok){
                showAlert("Novedad actualizada correctamente","success");
                bootstrap.Modal.getInstance(document.getElementById("modalEdit")).hide();
                table.ajax.reload(null,false);
            } else showAlert("Error al actualizar la novedad","danger");
        }catch{
            showAlert("Error inesperado","danger");
        }finally{
            enableButton(editBtn,originalTextEdit);
        }
    });

    resetModalForm("modalEdit","formEdit",["editEmpleado","editTipoNovedad","editFechaInicio","editFechaFin","editObservacion"]);

    //  Eliminar
    let deleteId = null;
    const deleteBtn = document.getElementById("confirmDelete");
    document.getElementById("NovedadesTable").addEventListener("click", e=>{
        const btn = e.target.closest(".delete-btn");
        if(!btn) return;
        deleteId = btn.dataset.id;
        bootstrap.Modal.getOrCreateInstance(document.getElementById("modalDelete")).show();
    });

    deleteBtn.addEventListener("click", async ()=>{
        if(!deleteId) return;
        disableButtonWithSpinner(deleteBtn,"Eliminando...");
        try{
            const res = await fetch(`/api/novedades-asistencia/${deleteId}/`,{
                method:"DELETE",
                headers:{"X-CSRFToken":"{{ csrf_token }}"}
            });
            if(res.ok){
                showAlert("Novedad eliminada correctamente","success");
                bootstrap.Modal.getInstance(document.getElementById("modalDelete")).hide();
                table.ajax.reload(null,false);
            } else showAlert("Error al eliminar la novedad","danger");
        }catch{
            showAlert("Error inesperado","danger");
        }finally{
            deleteId = null;
            enableButton(deleteBtn,"Eliminar");
        }
    });
});
</script>
{% endblock %}
