{% extends "dashboard.html" %}

{% block container_class %}justify-content-start align-items-start{% endblock %}

{% block content %}
<!-- Contenedor para los gráficos -->
<div class="mb-4">
    <h3 class="text-center fw-bold mb-2">Análisis de Registros de Asistencia</h3>
    <div class="row">
        <div class="col-12 col-sm-6 col-md-4 mb-4">
            <canvas id="graphic-entradas"></canvas>
        </div>
        <div class="col-12 col-sm-6 col-md-4 mb-4">
            <canvas id="graphic-salidas"></canvas>
        </div>
        <div class="col-12 col-sm-6 col-md-4 mb-4">
            <canvas id="graphic-sedes"></canvas>
        </div>
    </div>
</div>

<h3 class="mb-2 d-flex justify-content-center align-items-center fw-bold text-center">Registros de Asistencia | Hoy</h3>

<!-- Tabla -->
<div class="card shadow-sm border-0 rounded-3">
    <div class="card-body p-3">
        <div class="table-responsive">
            <table class="table table-striped table-hover table-borderless align-middle text-center w-100 fs-6" id="AttendanceTable">
                <thead class="table-dark border-bottom border-2 fw-semibold">
                    <tr>
                        <th>#</th>
                        <th>EMPLEADO</th>
                        <th>FECHA</th>
                        <th>HORA</th>
                        <th>DESCRIPCIÓN</th>
                        <th>LUGAR</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        async function cargarRegistrosDelDia() {
            const response = await fetch("/api/registros-asistencias/");
            const data = await response.json();
            return data;
        }

        const tablaRegistros = $("#AttendanceTable").DataTable({
            responsive: true,
            lengthChange: false,
            paging: false,
            searching: false,
            scrollCollapse: true,
            scrollY: '35vh',
            order: [[3, 'desc']],
            language: {
                url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json"
            },
            ajax: {
                url: "/api/registros-asistencias/",
                dataSrc: ""
            },
            dom: 'Bfrtip',
            buttons: [
                {
                    text: '<i class="bi bi-arrow-clockwise me-2 fs-5"></i> Recargar',
                    className: 'btn btn-link bg-white text-primary',
                    action: function (e, dt, node, config) {
                        dt.ajax.reload(null, false);
                    }
                }
            ],
            columns: [
                { data: "id" },
                { data: "nombre_empleado", render: nombre => nombre.toUpperCase() || "-" },
                { data: "fecha", render: fecha => fecha || "-" },
                { data: "hora", render: hora => hora || "-" },
                { data: "descripcion_registro", render: desc => desc.toUpperCase() || "-" },
                { data: "lugar_registro", render: lugar => lugar ? lugar.toUpperCase() : "-" }
            ]
        });

        function agruparPorRango(data) {
            // Rangos en formato 12 horas AM/PM
            const rangos = [
                "05:00 a. m. - 06:00 a. m.","06:00 a. m. - 07:00 a. m.","07:00 a. m. - 08:00 a. m.","08:00 a. m. - 09:00 a. m.",
                "09:00 a. m. - 10:00 a. m.","10:00 a. m. - 11:00 a. m.","11:00 a. m. - 12:00 p. m.","12:00 p. m. - 01:00 p. m.",
                "01:00 p. m. - 02:00 p. m.","02:00 p. m. - 03:00 p. m.","03:00 p. m. - 04:00 p. m.","04:00 p. m. - 05:00 p. m.",
                "05:00 p. m. - 06:00 p. m.","06:00 p. m. - 07:00 p. m.","07:00 p. m. - 08:00 p. m."
            ];

            const contarRango = (horaStr, rangos) => {
                let hora = parseInt(horaStr.split(":")[0]);
                const minuto = parseInt(horaStr.split(":")[1]);
                if (hora === 0) hora = 12; // 12 AM
                const ampm = horaStr.split(" ")[1]; // si tu hora ya viene en AM/PM
                for (const rango of rangos) {
                    const inicioRango = rango.split("-")[0].trim();
                    const finRango = rango.split("-")[1].trim();
                    const horaInicio = parseInt(inicioRango.split(":")[0]);
                    const horaFin = parseInt(finRango.split(":")[0]);
                    const ampmInicio = inicioRango.split(" ")[1];
                    const ampmFin = finRango.split(" ")[1];

                    let horaComparar = hora;
                    if (ampm === "p. m." && hora < 12) horaComparar += 12;
                    let horaInicioCmp = horaInicio;
                    if (ampmInicio === "p. m." && horaInicio < 12) horaInicioCmp += 12;
                    let horaFinCmp = horaFin;
                    if (ampmFin === "p. m." && horaFin < 12) horaFinCmp += 12;

                    if (horaComparar >= horaInicioCmp && horaComparar < horaFinCmp) return rango;
                }
                return "Otros";
            }

            const entradas = {};
            const salidas = {};

            data.forEach(registro => {
                if (!registro.hora) return;
                const descripcion = registro.descripcion_registro.toLowerCase();
                const rango = contarRango(registro.hora, rangos);

                if (descripcion.includes("entrada")) entradas[rango] = (entradas[rango] || 0) + 1;
                else if (descripcion.includes("salida")) salidas[rango] = (salidas[rango] || 0) + 1;
            });

            // Filtrar solo los rangos que tienen registros
            const rangosEntrada = Object.keys(entradas).filter(r => entradas[r] > 0);
            const rangosSalida = Object.keys(salidas).filter(r => salidas[r] > 0);

            return { entradas, salidas, rangosEntrada, rangosSalida };
        }

        function agruparPorSede(data) {
            const sedes = {};
            data.forEach(registro => {
                const sede = registro.lugar_registro || "Sin especificar";
                sedes[sede] = (sedes[sede] || 0) + 1;
            });
            return sedes;
        }

        function createGraphics(data) {
            const { entradas, salidas, rangosEntrada, rangosSalida } = agruparPorRango(data);

            const colores = ['#86A69D', '#F2B263', '#F2E8DF', '#F2C6C2', '#F28585'];

            // Gráfico de entradas
            new Chart(document.getElementById("graphic-entradas"), {
                type: "doughnut",
                data: {
                    labels: rangosEntrada,
                    datasets: [{
                        label: "Entradas",
                        data: rangosEntrada.map(r => entradas[r]),
                        backgroundColor: rangosEntrada.map((_, i) => colores[i % colores.length]),
                        borderColor: "#fff",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 1,
                    plugins: {
                        legend: { display: true, position: 'bottom', labels: { boxWidth: 15, padding: 10 } },
                        title: { display: true, text: "Distribución de Entradas por Rango de Horas", padding: { top: 10, bottom: 10 } }
                    }
                }
            });

            // Gráfico de salidas
            new Chart(document.getElementById("graphic-salidas"), {
                type: "doughnut",
                data: {
                    labels: rangosSalida,
                    datasets: [{
                        label: "Salidas",
                        data: rangosSalida.map(r => salidas[r]),
                        backgroundColor: rangosSalida.map((_, i) => colores[i % colores.length]),
                        borderColor: "#fff",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 1,
                    plugins: {
                        legend: { display: true, position: 'bottom', labels: { boxWidth: 15, padding: 10 } },
                        title: { display: true, text: "Distribución de Salidas por Rango de Horas", padding: { top: 10, bottom: 10 } }
                    }
                }
            });

            // Gráfico de sedes
            const sedes = agruparPorSede(data);
            const labelsSedes = Object.keys(sedes);
            const dataSedes = labelsSedes.map(s => sedes[s]);

            new Chart(document.getElementById("graphic-sedes"), {
                type: "doughnut",
                data: {
                    labels: labelsSedes,
                    datasets: [{
                        label: "Sedes",
                        data: dataSedes,
                        backgroundColor: labelsSedes.map((_, i) => colores[i % colores.length]),
                        borderColor: "#fff",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 1,
                    plugins: {
                        legend: { display: true, position: 'bottom', labels: { boxWidth: 15, padding: 10 } },
                        title: { display: true, text: "Distribución de Registros por Sede", padding: { top: 10, bottom: 10 } }
                    }
                }
            });
        }

        cargarRegistrosDelDia().then(data => createGraphics(data));
    });
</script>

{% endblock %}
