{% extends "dashboard.html" %}

{% block container_class %}justify-content-start align-items-start{% endblock %}

{% block content %}
<h3 class="mb-3 d-flex justify-content-center align-items-center fw-bold">Registros de Hoy</h3>

<!-- Tabla -->
<div class="card shadow-sm border-0 rounded-3">
    <div class="card-body p-3">
        <div class="table-responsive-md">
            <table class="table table-striped table-hover table-borderless align-middle text-center w-100 fs-6" id="AttendanceTable">
                <thead class="table-dark border-bottom border-2 fw-semibold">
                    <tr>
                        <th>#</th>
                        <th>EMPLEADO</th>
                        <th>FECHA</th>
                        <th>HORA</th>
                        <th>DESCRIPCIÓN</th>
                        <th>LUGAR</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<!-- Contenedor para los gráficos -->
<div class="mt-5">
    <h4 class="text-center">Análisis de Horarios</h4>
    <div class="row">
        <div class="col-md-6">
            <canvas id="grafico-entradas"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="grafico-salidas"></canvas>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Función para cargar los registros del día
        async function cargarRegistrosDelDia() {
            const response = await fetch("/api/registros-asistencias/");
            const data = await response.json();
            return data;
        }

        // Inicializar DataTable
        const tablaRegistros = $("#AttendanceTable").DataTable({
            paging: false,
            scrollCollapse: true,
            scrollY: '20vh',
            ajax: {
                url: "/api/registros-asistencias/",
                dataSrc: ""
            },
            columns: [
                { data: "id" },
                { data: "nombre_empleado", render: nombre => nombre.toUpperCase() || "-" },
                { data: "fecha", render: fecha => fecha || "-" },
                { data: "hora", render: hora => hora || "-" },
                { data: "descripcion_registro", render: desc => desc.toUpperCase() || "-" },
                { data: "lugar_registro", render: lugar => lugar ? lugar.toUpperCase() : "-" }
            ]
        });

        // Función para generar gráficos de entradas y salidas
        function generarGraficos(data) {
            const horasEntrada = {};
            const horasSalida = {};

            data.forEach(registro => {
                if (!registro.hora) return;
                const hora = registro.hora.split(":")[0]; // Extrae la hora
                const descripcion = registro.descripcion_registro.toLowerCase();

                if (descripcion.includes("entrada")) {
                    horasEntrada[hora] = (horasEntrada[hora] || 0) + 1;
                } else if (descripcion.includes("salida")) {
                    horasSalida[hora] = (horasSalida[hora] || 0) + 1;
                }
            });

            // Gráfico de entradas
            new Chart(document.getElementById("grafico-entradas"), {
                type: "bar",
                data: {
                    labels: Object.keys(horasEntrada),
                    datasets: [{
                        label: "Entradas",
                        data: Object.values(horasEntrada),
                        backgroundColor: "rgba(75, 192, 192, 0.6)",
                        borderColor: "rgba(75, 192, 192, 1)",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        title: { display: true, text: "Horas de Entrada" }
                    }
                }
            });

            // Gráfico de salidas
            new Chart(document.getElementById("grafico-salidas"), {
                type: "bar",
                data: {
                    labels: Object.keys(horasSalida),
                    datasets: [{
                        label: "Salidas",
                        data: Object.values(horasSalida),
                        backgroundColor: "rgba(255, 99, 132, 0.6)",
                        borderColor: "rgba(255, 99, 132, 1)",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        title: { display: true, text: "Horas de Salida" }
                    }
                }
            });
        }

        // Cargar registros y generar gráficos
        cargarRegistrosDelDia().then(data => generarGraficos(data));
    });
</script>
{% endblock %}
