{% extends "dashboard.html" %}

{% block title %}Registros de Asistencia{% endblock %}
{% block container_class %}justify-content-start align-items-start{% endblock %}

{% block content %}
<h5 class="mb-4 d-flex justify-content-center align-items-center fw-bold">Registros de Asistencia</h5>

<!-- Filtros -->
<div class="accordion mb-1" id="accordionFilters">
    <div class="accordion-item border-0 shadow-sm rounded-3">
        <h2 class="accordion-header" id="headingFilters">
            <button class="accordion-button collapsed fw-semibold text-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilters" aria-expanded="false" aria-controls="collapseFilters">
                <i class="bi bi-funnel-fill me-2 text-primary"></i> Filtros de búsqueda
            </button>
        </h2>

        <div id="collapseFilters" class="accordion-collapse collapse" aria-labelledby="headingFilters" data-bs-parent="#accordionFilters">
            <div class="accordion-body pt-3">
                <div class="row g-3 align-items-center">
                    <!-- Filtro de Empleado -->
                    <div class="form-floating col-md-2">
                        <select id="filterEmployee" class="form-select">
                            <option value="">Todos</option>
                        </select>
                        <label for="filterEmployee" class="form-label">Empleado</label>
                    </div>
                    <!-- Filtro Fecha inicio -->
                    <div class="form-floating col-md-2">
                        <input type="date" id="filterStartDate" class="form-control">
                        <label for="filterStartDate" class="form-label">Fecha inicio</label>
                    </div>
                    <!-- Filtro Fecha fin -->
                    <div class="form-floating col-md-2">
                        <input type="date" id="filterEndDate" class="form-control">
                        <label for="filterEndDate" class="form-label">Fecha fin</label>
                    </div>
                    <!-- Filtro de Descripción -->
                    <div class="form-floating col-md-2">
                        <select id="filterDescription" class="form-select">
                            <option value="">Todos</option>
                            <option value="Entrada">Entrada</option>
                            <option value="Salida">Salida</option>
                        </select>
                        <label for="filterDescription" class="form-label">Descripción</label>
                    </div>
                    <!-- Filtro de Área de Trabajo -->
                    <div class="form-floating col-md-2">
                        <select id="filterWorkArea" class="form-select">
                            <option value="">Todas</option>
                        </select>
                        <label for="filterWorkArea" class="form-label">Área de Trabajo</label>
                    </div>
                    <!-- Filtro de Sede -->
                    <div class="form-floating col-md-2">
                        <select id="filterSede" class="form-select">
                            <option value="">Todas</option>
                        </select>
                        <label for="filterSede" class="form-label">Sede</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Limpiar Filtros -->
<div class="d-flex justify-content-end mb-3">
    <button id="clearFilters" class="btn btn-link text-decoration-none text-secondary p-0 fw-semibold" disabled>
        Limpiar filtros
    </button>
</div>

<!-- Tabla -->
<div class="card shadow-sm border-0 rounded-3">
    <div class="card-body p-3">
        <div class="table-responsive-md">
            <table class="table table-striped table-hover table-borderless align-middle text-center w-100" id="AttendanceTable">
                <thead class="table-dark border-bottom border-2 fw-semibold">
                    <tr>
                        <th>EMPLEADO</th>
                        <th>FECHA</th>
                        <th>HORA</th>
                        <th>DESCRIPCIÓN</th>
                        <th>ESTADO</th>
                        <th>TIEMPO</th>
                        <th>LUGAR</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        let empleados = [];
        let table = null;
        const filterInputs = [
            "filterEmployee",
            "filterStartDate",
            "filterEndDate",
            "filterDescription",
            "filterWorkArea",
            "filterSede"
        ].map(id => document.getElementById(id));

        // Inicializar DataTable
        table = initDataTable("#AttendanceTable", {
            serverSide: true,
            processing: true,
            ajax: {
                url: "/api/registros-asistencias/",
                type: "GET",
                data: function (d) {
                    d.employee = document.getElementById("filterEmployee").value;
                    d.start_date = document.getElementById("filterStartDate").value;
                    d.end_date = document.getElementById("filterEndDate").value;
                    d.description = document.getElementById("filterDescription").value;
                    d.work_area = document.getElementById("filterWorkArea").value;
                    d.sede = document.getElementById("filterSede").value;
                },
                dataSrc: "data"
            },
            columns: [
                { data: "nombre_empleado", render: nombre_empleado => nombre_empleado ? nombre_empleado.toUpperCase() : "-" },
                { data: "fecha", render: fecha => fecha || "-" },
                { data: "hora", render: hora => hora || "-" },
                { data: "descripcion_registro", render: descripcion_registro => descripcion_registro.toUpperCase() || "-" },
                { data: "estado_registro", render: estado_registro => estado_registro ? estado_registro.toUpperCase() : "-" },
                {
                    data: "minutos",
                    render: minutos => {
                        if (minutos === null) return "-";
                        if (minutos < 60) return `${minutos} min`;
                        const horas = Math.floor(minutos / 60);
                        const mins = minutos % 60;
                        return mins > 0 ? `${horas} h ${mins} min` : `${horas} h`;
                    }
                },
                { data: "lugar_registro", render: lugar_registro => lugar_registro ? lugar_registro.toUpperCase() : "-" }
            ]
        }, true);

        // Cargar Empleados, Áreas de Trabajo y Sedes
        try {
            const [resEmp, resAreas, resSedes] = await Promise.all([
                fetch("/api/empleados/"),
                fetch("/api/areas-trabajo/"),
                fetch("/api/sedes/")
            ]);

                empleados = await resEmp.json();
                areas = await resAreas.json();
            sedes = await resSedes.json();

            // Filtros
            fillSelect("filterEmployee", empleados, "Todos", "nombre_completo");
            fillSelect("filterWorkArea", areas, "Todas", "area");
            fillSelect("filterSede", sedes, "Todas", "ubicacion",
                sede => {
                    return `${sede.ubicacion.toUpperCase()} - ${sede.ciudad.toUpperCase()}`;
                }
            );

        } catch (error) {
            console.log(error)
            showAlert("Error cargando empleados, áreas de trabajo o sede", "danger");
        }

        // Filtro automático con DataTables API
        $.fn.dataTable.ext.search.push((settings, data, dataIndex, rowData) => {
            const empId = document.getElementById("filterEmployee").value;
            const startDate = document.getElementById("filterStartDate").value;
            const endDate = document.getElementById("filterEndDate").value;
            const description = document.getElementById("filterDescription").value;
            const workAreaId = document.getElementById("filterWorkArea").value;
            const sedeId = document.getElementById("filterSede").value;

            let show = true;

            // Filtrar por empleado
            if (empId && rowData.fk_empleado != parseInt(empId)) {
                show = false;
            }

            // Filtrar por fecha inicio
            if (startDate) {
                const regDate = new Date(rowData.fecha.split("/").reverse().join("-"));
                if (regDate < new Date(startDate)) show = false;
            }

            // Filtrar por fecha fin
            if (endDate) {
                const regDate = new Date(rowData.fecha.split("/").reverse().join("-"));
                if (regDate > new Date(endDate)) show = false;
            }

            // Filtrar por descripción
            if (description && rowData.descripcion_registro.toLowerCase() !== description.toLowerCase()) {
                show = false;
            }

            // Filtrar por área de trabajo
            if (workAreaId && !rowData.fk_areas_trabajo.includes(parseInt(workAreaId))) {
                show = false;
            }

            // Filtrar por sede
            if (sedeId && rowData.fk_sede != parseInt(sedeId)) {
                show = false;
            }

            return show;
        });

        // Eventos de filtros
        filterInputs[0].addEventListener("change", () => table.ajax.reload());
        filterInputs[1].addEventListener("change", () => table.ajax.reload());
        filterInputs[2].addEventListener("change", () => table.ajax.reload());
        filterInputs[3].addEventListener("input", () => table.ajax.reload());
        filterInputs[4].addEventListener("change", () => table.ajax.reload());
        filterInputs[5].addEventListener("change", () => table.ajax.reload());

        // Limpiar Filtros
        const clearBtn = document.getElementById("clearFilters");
        const checkFilters = () => {
            const hasFilters = filterInputs.some(input => input.value && input.value.trim() !== "");
            clearBtn.disabled = !hasFilters;
            clearBtn.classList.toggle("text-secondary", !hasFilters);
            clearBtn.classList.toggle("text-primary", hasFilters);
        };

        // Escucha cambios en todos los filtros
        filterInputs.forEach(input => {
            input.addEventListener("change", checkFilters);
            input.addEventListener("input", checkFilters);
        });

        // botón para limpiar filtros
        clearBtn.addEventListener("click", () => {
            filterInputs.forEach(input => input.value = "");
            table.ajax.reload();
            checkFilters();
            // Cerrar acordeón al limpiar
            const collapse = bootstrap.Collapse.getOrCreateInstance(document.getElementById("collapseFilters"));
            collapse.hide();
        });

        // Inicializar estado del botón
        checkFilters();
    });
</script>
{% endblock %}