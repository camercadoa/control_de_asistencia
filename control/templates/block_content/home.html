{% extends "dashboard.html" %}

{% block container_class %}justify-content-start align-items-start{% endblock %}

{% block content %}
    <h3 class="mb-3 d-flex justify-content-center align-items-center fw-bold">Registros de Hoy</h3>
    
    <!-- Tabla de registros del día -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Empleado</th>
                    <th>Documento</th>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Descripción</th>
                    <th>Lugar</th>
                </tr>
            </thead>
            <tbody id="registros-dia">
                <!-- Los datos se cargarán dinámicamente -->
            </tbody>
        </table>
    </div>

    <!-- Contenedor para los gráficos -->
    <div class="mt-5">
        <h4 class="text-center">Análisis de Horarios</h4>
        <div class="row">
            <div class="col-md-6">
                <canvas id="grafico-ingresos"></canvas>
            </div>
            <div class="col-md-6">
                <canvas id="grafico-salidas"></canvas>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Función para cargar los registros del día
            async function cargarRegistrosDelDia() {
                const response = await fetch("{% url 'ApiRegistrosAsistencias' %}?fecha_hoy=true");
                const data = await response.json();
                const tbody = document.getElementById("registros-dia");
                tbody.innerHTML = "";

                data.forEach(registro => {
                    const row = `
                        <tr>
                            <td>${registro.nombre_empleado}</td>
                            <td>${registro.documento}</td>
                            <td>${registro.fecha}</td>
                            <td>${registro.hora}</td>
                            <td>${registro.descripcion_registro}</td>
                            <td>${registro.lugar_registro}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                return data;
            }

            // Función para generar gráficos
            function generarGraficos(data) {
                const horasIngreso = {};
                const horasSalida = {};

                data.forEach(registro => {
                    const hora = registro.hora.split(":")[0]; // Extraer la hora
                    if (registro.descripcion_registro.toLowerCase().includes("ingreso")) {
                        horasIngreso[hora] = (horasIngreso[hora] || 0) + 1;
                    } else if (registro.descripcion_registro.toLowerCase().includes("salida")) {
                        horasSalida[hora] = (horasSalida[hora] || 0) + 1;
                    }
                });

                // Gráfico de ingresos
                new Chart(document.getElementById("grafico-ingresos"), {
                    type: "bar",
                    data: {
                        labels: Object.keys(horasIngreso),
                        datasets: [{
                            label: "Ingresos",
                            data: Object.values(horasIngreso),
                            backgroundColor: "rgba(75, 192, 192, 0.6)",
                            borderColor: "rgba(75, 192, 192, 1)",
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true },
                            title: { display: true, text: "Horas de Ingreso" }
                        }
                    }
                });

                // Gráfico de salidas
                new Chart(document.getElementById("grafico-salidas"), {
                    type: "bar",
                    data: {
                        labels: Object.keys(horasSalida),
                        datasets: [{
                            label: "Salidas",
                            data: Object.values(horasSalida),
                            backgroundColor: "rgba(255, 99, 132, 0.6)",
                            borderColor: "rgba(255, 99, 132, 1)",
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true },
                            title: { display: true, text: "Horas de Salida" }
                        }
                    }
                });
            }

            // Cargar registros y generar gráficos
            cargarRegistrosDelDia().then(data => generarGraficos(data));
        });
    </script>
{% endblock %}