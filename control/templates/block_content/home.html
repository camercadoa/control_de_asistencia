{% extends "dashboard.html" %}

{% block container_class %}justify-content-start align-items-start{% endblock %}

{% block content %}

<div class="d-flex flex-column flex-md-row justify-content-center align-items-center">
    <!-- Título -->
    <h5 class="d-flex justify-content-center align-items-center fw-bold text-center">
        Análisis
        <span id="selectDateText" class="align-middle d-none">Hoy</span>
    </h5>

    <div class="d-none d-md-block vr ms-2"></div>

    <!-- Controles de fecha -->
    <div class="d-flex align-items-center">
        <button id="btnPreviousDay" class="btn btn-sm btn-link text-dark"><i class="bi bi-chevron-left"></i></button>
        <input type="date" id="selectDate" class="form-control w-auto">
        <button id="btnToday" class="btn btn-sm btn-link text-dark"><i class="bi bi-calendar-day"></i></button>
        <button id="btnNextDay" class="btn btn-sm btn-link text-dark"><i class="bi bi-chevron-right"></i></button>
    </div>
</div>

<!-- Contenedor para los gráficos -->
<div class="row justify-content-center gap-4 my-3">
    {% for tipo, titulo in tipos.items %}
    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body p-1 d-flex flex-column align-items-center">
                <div class="w-100 card-canvas text-center" style="max-width:280px;">
                    <canvas id="graphic-{{ tipo }}" width="280" height="260" style="max-width: 100%; height: auto;"></canvas>
                    <div id="no-data-{{ tipo }}" class="text-muted small d-none my-2">
                        No hay registros para el día seleccionado
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Tabla -->
<div class="card shadow-sm border-0 rounded-3">
    <div class="card-body p-3">
        <div class="table-responsive">
            <table class="table table-striped table-hover table-borderless align-middle text-center w-100" id="AttendanceTable">
                <thead class="table-dark border-bottom border-2 fw-semibold">
                    <tr>
                        <th>EMPLEADO</th>
                        <th>FECHA</th>
                        <th>HORA</th>
                        <th>DESCRIPCIÓN</th>
                        <th>LUGAR</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const selectDate = document.getElementById("selectDate");
    const fechaTexto = document.getElementById("selectDateText");
    const btnPreviousDay = document.getElementById("btnPreviousDay");
    const btnToday = document.getElementById("btnToday");
    const btnNextDay = document.getElementById("btnNextDay");

    let minFechaISO = null;
    let maxFechaISO = null;

    function formatearFechaInput(fecha) {
        const [d, m, y] = fecha.split("/");
        return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
    }
    function formatearFechaMostrar(valorInput) {
        const [y, m, d] = valorInput.split("-");
        return `${d.padStart(2,"0")}/${m.padStart(2,"0")}/${y}`;
    }
    function moverDias(fechaISO, dias) {
        const fecha = new Date(fechaISO);
        fecha.setDate(fecha.getDate() + dias);
        return fecha.toISOString().split("T")[0];
    }

    const hoy = fechaHoyFormato();
    selectDate.value = formatearFechaInput(hoy);
    let fechaSeleccionada = hoy;

    // --- DataTable ---
    const tablaRegistros = $("#AttendanceTable").DataTable({
        responsive: true,
        lengthChange: false,
        paging: false,
        searching: false,
        ordering: false,
        scrollCollapse: true,
        scrollY: '40vh',
        language: {
            url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json"
        },
        ajax: {
            url: "/api/registros-asistencias/",
            dataSrc: function(json) {
                return json.filter(r => r.fecha === fechaSeleccionada);
            }
        },
        dom: 'Bfrtip',
        buttons: [
            {
                text: '<i class="bi bi-arrow-clockwise me-1 text-primary"></i><span class="text-dark">Recargar</span>',
                className: 'btn btn-sm bg-white border-0',
                action: function (e, dt, node, config) {
                    dt.ajax.reload(null, false);
                }
            }
        ],
        columns: [
            { data: "nombre_empleado", render: nombre => nombre.toUpperCase() || "-" },
            { data: "fecha", render: fecha => fecha || "-" },
            { data: "hora", render: hora => hora || "-" },
            { data: "descripcion_registro", render: desc => desc.toUpperCase() || "-" },
            { data: "lugar_registro", render: lugar => lugar ? lugar.toUpperCase() : "-" }
        ]
    });

    tablaRegistros.on("xhr.dt", function (e, settings, json, xhr) {
        const filtrados = json.filter(r => r.fecha === fechaSeleccionada);
        createGraphics(filtrados);
    });

    function actualizarBotones(nuevaFechaISO) {
        btnPreviousDay.disabled = (minFechaISO && nuevaFechaISO <= minFechaISO);
        btnNextDay.disabled = (maxFechaISO && nuevaFechaISO >= maxFechaISO);
    }

    function actualizarVista(nuevaFechaISO) {
        fechaSeleccionada = formatearFechaMostrar(nuevaFechaISO);
        selectDate.value = nuevaFechaISO;
        fechaTexto.textContent = (fechaSeleccionada === hoy) ? "Hoy" : fechaSeleccionada;
        tablaRegistros.ajax.reload();
        actualizarBotones(nuevaFechaISO);

        fetch("/api/registros-asistencias/")
            .then(res => res.json())
            .then(data => {
                const filtrados = data.filter(r => r.fecha === fechaSeleccionada);
                createGraphics(filtrados);
            });
    }

    selectDate.addEventListener("change", function () {
        actualizarVista(this.value);
    });
    btnToday.addEventListener("click", function () {
        actualizarVista(formatearFechaInput(hoy));
    });
    btnPreviousDay.addEventListener("click", function () {
        actualizarVista(moverDias(selectDate.value, -1));
    });
    btnNextDay.addEventListener("click", function () {
        actualizarVista(moverDias(selectDate.value, 1));
    });

    // --- Funciones de gráficos ---
    function agruparPorRango(data) {
        const rangos = [
            "05:00 a. m. - 06:00 a. m.","06:00 a. m. - 07:00 a. m.","07:00 a. m. - 08:00 a. m.","08:00 a. m. - 09:00 a. m.",
            "09:00 a. m. - 10:00 a. m.","10:00 a. m. - 11:00 a. m.","11:00 a. m. - 12:00 p. m.","12:00 p. m. - 01:00 p. m.",
            "01:00 p. m. - 02:00 p. m.","02:00 p. m. - 03:00 p. m.","03:00 p. m. - 04:00 p. m.","04:00 p. m. - 05:00 p. m.",
            "05:00 p. m. - 06:00 p. m.","06:00 p. m. - 07:00 p. m.","07:00 p. m. - 08:00 p. m."
        ];
        const entradas = {}, salidas = {};
        const contarRango = (horaStr, rangos) => {
            let hora = parseInt(horaStr.split(":")[0]);
            const ampm = horaStr.split(" ")[1];
            if (hora === 0) hora = 12;
            for (const rango of rangos) {
                const [ini, fin] = rango.split("-");
                const horaIni = parseInt(ini.split(":")[0]);
                const horaFin = parseInt(fin.split(":")[0]);
                const ampmIni = ini.split(" ")[1];
                const ampmFin = fin.split(" ")[1];
                let cmp = hora;
                if (ampm === "p. m." && hora < 12) cmp += 12;
                let cmpIni = horaIni;
                if (ampmIni === "p. m." && horaIni < 12) cmpIni += 12;
                let cmpFin = horaFin;
                if (ampmFin === "p. m." && horaFin < 12) cmpFin += 12;
                if (cmp >= cmpIni && cmp < cmpFin) return rango;
            }
            return "Otros";
        };
        data.forEach(r => {
            if (!r.hora) return;
            const desc = r.descripcion_registro.toLowerCase();
            const rango = contarRango(r.hora, rangos);
            if (desc.includes("entrada")) entradas[rango] = (entradas[rango]||0)+1;
            else if (desc.includes("salida")) salidas[rango] = (salidas[rango]||0)+1;
        });
        return {
            entradas, salidas,
            rangosEntrada: Object.keys(entradas).filter(r => entradas[r]>0),
            rangosSalida: Object.keys(salidas).filter(r => salidas[r]>0)
        };
    }
    function agruparPorSede(data) {
        const sedes = {};
        data.forEach(r => {
            const sede = r.lugar_registro || "Sin especificar";
            sedes[sede] = (sedes[sede]||0)+1;
        });
        return sedes;
    }

    function createGraphics(data) {
        if (!data || data.length === 0) {
            ["entradas", "salidas", "sedes"].forEach(tipo => {
                document.getElementById("graphic-" + tipo).classList.add("d-none");
                document.getElementById("no-data-" + tipo).classList.remove("d-none");
            });
            return;
        }

        ["entradas", "salidas", "sedes"].forEach(tipo => {
            document.getElementById("graphic-" + tipo).classList.remove("d-none");
            document.getElementById("no-data-" + tipo).classList.add("d-none");
        });

        ["graphic-entradas", "graphic-salidas", "graphic-sedes"].forEach(id => {
            const canvas = document.getElementById(id);
            if (canvas.chart) canvas.chart.destroy();
        });

        const { entradas, salidas, rangosEntrada, rangosSalida } = agruparPorRango(data);
        const sedes = agruparPorSede(data);

        const colores = [
            '#86A69D', '#F2B263', '#F2E8DF', '#F2C6C2', '#F28585', '#6FA3EF',
            '#F5A623', '#7BDCB5', '#C879FF', '#FF9F80', '#E8E288', '#A1C45A'
        ];

        const crearGrafico = (id, etiquetas, valores, titulo) => {
            if (valores.every(v => v === 0)) {
                document.getElementById(id).classList.add("d-none");
                document.getElementById("no-data-" + id.split("-")[1]).classList.remove("d-none");
                return;
            }
            const chart = new Chart(document.getElementById(id), {
                type: "doughnut",
                data: {
                    labels: etiquetas,
                    datasets: [{
                        data: valores,
                        backgroundColor: etiquetas.map((_, i) => colores[i % colores.length]),
                        borderWidth: 1,
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    layout: {
                        padding: { top: 10, bottom: 10 }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: titulo,
                            font: { size: 14, weight: 'bold' },
                            padding: { bottom: 10 }
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            align: 'center',
                            labels: {
                                boxWidth: 12,
                                font: { size: 10 },
                                padding: 8
                            }
                        }
                    }
                }
            });
            document.getElementById(id).chart = chart;
        };

        crearGrafico("graphic-entradas", rangosEntrada, rangosEntrada.map(r => entradas[r]), "Entradas");
        crearGrafico("graphic-salidas", rangosSalida, rangosSalida.map(r => salidas[r]), "Salidas");
        crearGrafico("graphic-sedes", Object.keys(sedes), Object.values(sedes), "Sedes");
    }

    fetch("/api/registros-asistencias/")
        .then(res=>res.json())
        .then(data => {
            const fechas = data.map(r => r.fecha).sort((a,b)=>{
                const [da,ma,ya] = a.split("/");
                const [db,mb,yb] = b.split("/");
                return new Date(`${ya}-${ma}-${da}`) - new Date(`${yb}-${mb}-${db}`);
            });
            if (fechas.length > 0) {
                minFechaISO = formatearFechaInput(fechas[0]);
                maxFechaISO = formatearFechaInput(fechas[fechas.length-1]);
            }

            const filtrados = data.filter(r => r.fecha === hoy);
            createGraphics(filtrados);
            actualizarBotones(selectDate.value);
        });
});
</script>
{% endblock %}
